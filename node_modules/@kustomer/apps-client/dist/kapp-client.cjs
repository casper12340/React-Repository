'use strict';

var chunk53A5GD2E_cjs = require('./chunk-53A5GD2E.cjs');
var appsCommon = require('@kustomer/apps-common');
var m = require('axios');
var b = require('uuid');
var sqlstring = require('sqlstring');
var kappModal = require('./kapp-modal');
var o = require('./events');
var errors = require('./errors');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

function _interopNamespace(e) {
	if (e && e.__esModule) return e;
	var n = Object.create(null);
	if (e) {
		Object.keys(e).forEach(function (k) {
			if (k !== 'default') {
				var d = Object.getOwnPropertyDescriptor(e, k);
				Object.defineProperty(n, k, d.get ? d : {
					enumerable: true,
					get: function () { return e[k]; }
				});
			}
		});
	}
	n.default = e;
	return Object.freeze(n);
}

var m__default = /*#__PURE__*/_interopDefault(m);
var b__namespace = /*#__PURE__*/_interopNamespace(b);
var o__namespace = /*#__PURE__*/_interopNamespace(o);

const h=class h{constructor(t){chunk53A5GD2E_cjs.b(this,"options");chunk53A5GD2E_cjs.b(this,"id");chunk53A5GD2E_cjs.b(this,"origin");chunk53A5GD2E_cjs.b(this,"log");chunk53A5GD2E_cjs.b(this,"_context");chunk53A5GD2E_cjs.b(this,"_visibility");chunk53A5GD2E_cjs.b(this,"_initialized");chunk53A5GD2E_cjs.b(this,"_fetchData");chunk53A5GD2E_cjs.b(this,"_api");chunk53A5GD2E_cjs.b(this,"_subscriptions");chunk53A5GD2E_cjs.b(this,"_modals");chunk53A5GD2E_cjs.b(this,"_requests");chunk53A5GD2E_cjs.b(this,"targetModal");chunk53A5GD2E_cjs.b(this,"modalToken");chunk53A5GD2E_cjs.b(this,"onContextChange");this.options=t,this._initialized=!1,this._fetchData=!0,this._subscriptions={},this._modals={},this._requests={};const i=this._parseQueryParam("id"),e=this._parseQueryParam("parentUrl");if(!i||!e)throw new Error(errors.Errors.NoIDOrOrigin);this.id=i,this.origin=e,this.log=this.options.logger||new appsCommon.Logger(this.options.app),this._fetchData=this.options.shouldFetchData||!0,this._visibility=this.options.visibility||"private",this.targetModal=void 0,this.modalToken=void 0,window.addEventListener("message",this._onMessage.bind(this),!1),this._subscriptions[o__namespace.App.ContextUpdate]=this._onContextUpdate.bind(this),this._subscriptions[o__namespace.App.Request]=this._onRequest.bind(this);}get context(){return this._context}get visibility(){return this._visibility}get initialized(){return this._initialized}get fetchData(){return this._fetchData}get api(){if(!this._api)throw new Error(errors.Errors.MustInitializeFirst);return this._api}get height(){const t=document.body,i=document.documentElement;return Math.max(t.scrollHeight,t.offsetHeight,i.clientHeight,i.scrollHeight,i.offsetHeight)}hide(){this.targetModal&&parent.postMessage({cardId:this.id,type:o__namespace.Modal.Hide},this.origin);}async start(t){const e=new URL(this.origin).host.split(".")[0],r=m__default.default.create({adapter:a=>new Promise((n,g)=>{const d=b__namespace.v4();this._requests[d]={resolve:n,reject:g},this._publish(o__namespace.App.Request,{requestId:d,method:a.method,url:a.url,body:a.data?JSON.parse(a.data):void 0});})});return this._api=new appsCommon.API({orgNameOrId:e,options:{...this.options,logger:this.log,axios:r}}),t&&(this.onContextChange=t),new Promise(a=>{if(this._initialized)return a(this._context);this._subscriptions[o__namespace.App.Initialize]=n=>{this._initialized=!0,n&&this.resize(),this._onContextUpdate(n),a(n);},this._publish(o__namespace.App.Initialize,{height:this.height});})}resize(t={height:this.height}){this._publish(o__namespace.App.Resize,t);}open(){this._publish(o__namespace.App.Open);}close(){this._publish(o__namespace.App.Close);}modal(t){const i=new kappModal.KAppModal(this.id,this.origin,this.log,t,this._subscriptions,()=>{delete this._modals[i.id];},()=>{this._modals={};});return this._modals[i.id]=i,i.create()}getModalById(t){return this._modals[t]}_onMessage(t){if(t.origin===this.origin&&(t.data.type===o__namespace.Modal.Initialize&&(this.targetModal=t.data.targetModal,this.modalToken=t.data.modalToken),!!this._subscriptions[t.data.type])){if(t.data.type===o__namespace.App.Request)return this._subscriptions[t.data.type]?.(t.data);this._subscriptions[t.data.type]?.({...t.data.context,targetModal:t.data.targetModal,modalToken:t.data.modalToken,userLocale:t.data.userLocale,userRoles:t.data.userRoles});}}_onContextUpdate(t){this._context=t,this.onContextChange&&this.onContextChange(t);}_onRequest(t){const{data:i,requestId:e,err:r}=t;if(!this._requests[e])return this.log.warn(`Request ${e} not found.`);if(r)this._requests[e].reject(r);else {const a=new m.AxiosHeaders;this._requests[e].resolve({data:{data:i},status:200,statusText:"",headers:a,config:{headers:a}});}}_parseQueryParam(t){const e=new URL(window.location.href).searchParams.get(t),r=sqlstring.escape(e);if(e&&e!=="null"&&e!=="NULL")return r.slice(1,-1)}_publish(t,i){parent.postMessage({...i,cardId:this.id,type:t,targetModal:this.targetModal,modalToken:this.modalToken},this.origin);}};chunk53A5GD2E_cjs.a(h,"KAppClient");let u=h;

exports.KAppClient = u;
